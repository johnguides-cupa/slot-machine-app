(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(o){if(o.ep)return;o.ep=!0;const i=t(o);fetch(o.href,i)}})();const y=[{id:"cambridge-shield",name:"Cambridge Shield",filename:"Cambridge Shield.png",path:"/slot-machine-app/assets/images/prizes/Cambridge%20Shield.png",description:"Cambridge Shield logo"},{id:"development-evp-shield",name:"Development EVP Shield",filename:"Development-EVP-shield.png",path:"/slot-machine-app/assets/images/prizes/Development-EVP-shield.png",description:"Development EVP shield logo"},{id:"inclusion-evp-shield",name:"Inclusion EVP Shield",filename:"Inclusion-EVP-shield.png",path:"/slot-machine-app/assets/images/prizes/Inclusion-EVP-shield.png",description:"Inclusion EVP shield logo"},{id:"innovation-evp-shield",name:"Innovation EVP Shield",filename:"Innovation-EVP-shield.png",path:"/slot-machine-app/assets/images/prizes/Innovation-EVP-shield.png",description:"Innovation EVP shield logo"},{id:"pursuing-potential-logo",name:"Pursuing Potential Logo",filename:"Pursuing Potential Logo.png",path:"/slot-machine-app/assets/images/prizes/Pursuing%20Potential%20Logo.png",description:"Pursuing Potential brand logo"}],P=h=>`/slot-machine-app/assets/images/prizes/${encodeURIComponent(h)}`;class b{constructor(){this.initializeDefaults()}initializeDefaults(){if(!this.getPrizes().length){const e=[{id:1,name:"Grand Prize",image:y[0].path,quantity:50,chance:1},{id:2,name:"2nd Prize",image:y[1].path,quantity:10,chance:2},{id:3,name:"3rd Prize",image:y[2].path,quantity:5,chance:3},{id:4,name:"Consolation",image:y[4].path,quantity:5,chance:94}];this.setPrizes(e)}}getPrizes(){const e=localStorage.getItem("prizes");return e?JSON.parse(e):[]}setPrizes(e){localStorage.setItem("prizes",JSON.stringify(e))}addPrize(e){const t=this.getPrizes();return e.id=Date.now(),t.push(e),this.setPrizes(t),e}updatePrize(e){const t=this.getPrizes(),n=t.findIndex(o=>o.id===e.id);return n!==-1?(t[n]=e,this.setPrizes(t),!0):!1}deletePrize(e){const t=this.getPrizes(),n=t.filter(o=>o.id!==e);return this.setPrizes(n),n.length!==t.length}getLogs(){const e=localStorage.getItem("spinLogs");return e?JSON.parse(e):[]}addLog(e){const t=this.getLogs();e.timestamp=new Date().toISOString(),t.unshift(e),t.length>100&&t.splice(100),localStorage.setItem("spinLogs",JSON.stringify(t))}clearLogs(){localStorage.removeItem("spinLogs")}resetAll(){localStorage.removeItem("prizes"),localStorage.removeItem("spinLogs"),this.initializeDefaults()}}window.storageManager=new b;class E{constructor(){this.sounds={},this.audioContext=null,this.isMuted=!1,this.volume=.5,this.initializeSounds(),this.createVolumeControl()}initializeSounds(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(e){console.warn("Web Audio API not supported:",e)}this.loadCustomSounds(),this.createProgrammaticSounds()}loadCustomSounds(){this.customSounds={};const e=new Audio("./assets/sounds/Congratulations.mp3");e.volume=this.volume,this.customSounds.congratulations=e;const t=new Audio("./assets/sounds/miaw.mp3");t.volume=this.volume,this.customSounds.miaw=t,e.addEventListener("error",()=>{console.warn("Could not load congratulations sound")}),t.addEventListener("error",()=>{console.warn("Could not load miaw sound")})}createProgrammaticSounds(){this.sounds={spin:()=>this.createSpinSound(),win:()=>this.createMelody([523,659,784,1047],.3),lose:()=>this.createTone(150,.8,"sine"),click:()=>this.createTone(800,.1,"square"),reelStop:()=>this.createTone(400,.2,"triangle"),jackpot:()=>this.createCelebrationSound(),background:()=>this.createAmbientSound()}}createSpinSound(){if(!this.audioContext||this.isMuted)return;const e=2.5,t=this.audioContext.createOscillator(),n=this.audioContext.createGain(),o=this.audioContext.createBiquadFilter();t.connect(o),o.connect(n),n.connect(this.audioContext.destination),t.frequency.setValueAtTime(400,this.audioContext.currentTime),t.frequency.exponentialRampToValueAtTime(200,this.audioContext.currentTime+e),t.type="sawtooth",o.type="lowpass",o.frequency.setValueAtTime(1e3,this.audioContext.currentTime),o.frequency.exponentialRampToValueAtTime(300,this.audioContext.currentTime+e),n.gain.setValueAtTime(0,this.audioContext.currentTime),n.gain.linearRampToValueAtTime(this.volume*.4,this.audioContext.currentTime+.1),n.gain.exponentialRampToValueAtTime(.001,this.audioContext.currentTime+e),t.start(this.audioContext.currentTime),t.stop(this.audioContext.currentTime+e);for(let i=0;i<8;i++)setTimeout(()=>{this.createTone(600+Math.random()*200,.05,"square")},i*300)}createTone(e,t,n="sine"){if(!this.audioContext||this.isMuted)return;const o=this.audioContext.createOscillator(),i=this.audioContext.createGain();o.connect(i),i.connect(this.audioContext.destination),o.frequency.setValueAtTime(e,this.audioContext.currentTime),o.type=n,i.gain.setValueAtTime(0,this.audioContext.currentTime),i.gain.linearRampToValueAtTime(this.volume*.3,this.audioContext.currentTime+.01),i.gain.exponentialRampToValueAtTime(.001,this.audioContext.currentTime+t),o.start(this.audioContext.currentTime),o.stop(this.audioContext.currentTime+t)}createMelody(e,t){!this.audioContext||this.isMuted||e.forEach((n,o)=>{setTimeout(()=>{this.createTone(n,t,"sine")},o*t*200)})}createCelebrationSound(){if(!this.audioContext||this.isMuted)return;[261,329,392,523,659,784,1047,1319].forEach((t,n)=>{setTimeout(()=>{this.createTone(t,.4,"sine")},n*100)}),setTimeout(()=>{for(let t=0;t<10;t++)setTimeout(()=>{this.createTone(1e3+Math.random()*1e3,.1,"square")},t*50)},800)}createAmbientSound(){if(!this.audioContext||this.isMuted)return;const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(60,this.audioContext.currentTime),e.type="sine",t.gain.setValueAtTime(this.volume*.1,this.audioContext.currentTime),e.start(),setTimeout(()=>{t.gain.exponentialRampToValueAtTime(.001,this.audioContext.currentTime+1),e.stop(this.audioContext.currentTime+1)},5e3)}playSound(e){if(this.sounds[e]&&!this.isMuted)try{this.audioContext&&this.audioContext.state==="suspended"?this.audioContext.resume().then(()=>{this.sounds[e]()}).catch(t=>{console.warn("Failed to resume audio context:",t)}):this.sounds[e]()}catch(t){console.warn("Error playing sound:",t)}else this.isMuted?console.log(`Sound ${e} muted`):console.warn(`Sound ${e} not found`)}mute(){this.isMuted=!0,this.updateVolumeButton()}unmute(){this.isMuted=!1,this.updateVolumeButton()}toggleMute(){this.isMuted=!this.isMuted,this.updateVolumeButton()}setVolume(e){this.volume=Math.max(0,Math.min(1,e)),this.updateVolumeSlider()}createVolumeControl(){const e=document.querySelector(".control-panel");if(!e)return;const t=document.createElement("div");t.className="sound-control",t.innerHTML=`
            <div class="sound-controls">
                <button id="muteButton" class="mute-button" title="Toggle Sound">
                    🔊
                </button>
                <input type="range" id="volumeSlider" class="volume-slider" 
                       min="0" max="100" value="50" title="Volume">
                <span class="volume-label">50%</span>
                <button id="testSoundButton" class="test-sound-button" title="Test Sound">
                    🎵
                </button>
            </div>
        `;const n=document.createElement("style");n.textContent=`
            .sound-control {
                margin-top: 15px;
                display: flex;
                justify-content: center;
            }
            
            .sound-controls {
                display: flex;
                align-items: center;
                gap: 10px;
                background: rgba(0,0,0,0.3);
                padding: 10px;
                border-radius: 8px;
                border: 2px solid #FFD700;
            }
            
            .mute-button {
                background: none;
                border: none;
                font-size: 1.5em;
                cursor: pointer;
                padding: 5px;
                border-radius: 4px;
                transition: all 0.2s ease;
            }
            
            .mute-button:hover {
                background: rgba(255,255,255,0.2);
            }
            
            .mute-button.muted {
                opacity: 0.5;
            }
            
            .test-sound-button {
                background: none;
                border: none;
                font-size: 1.2em;
                cursor: pointer;
                padding: 5px;
                border-radius: 4px;
                transition: all 0.2s ease;
            }
            
            .test-sound-button:hover {
                background: rgba(255,255,255,0.2);
            }
            
            .volume-slider {
                width: 100px;
                height: 5px;
                border-radius: 5px;
                background: #ddd;
                outline: none;
                -webkit-appearance: none;
            }
            
            .volume-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 15px;
                height: 15px;
                border-radius: 50%;
                background: #FFD700;
                cursor: pointer;
            }
            
            .volume-slider::-moz-range-thumb {
                width: 15px;
                height: 15px;
                border-radius: 50%;
                background: #FFD700;
                cursor: pointer;
                border: none;
            }
            
            .volume-label {
                color: white;
                font-weight: bold;
                min-width: 30px;
                text-align: center;
                font-size: 0.9em;
            }
        `,document.head.appendChild(n),e.appendChild(t),document.getElementById("muteButton").addEventListener("click",()=>{this.toggleMute(),this.playSound("click")}),document.getElementById("volumeSlider").addEventListener("input",o=>{const i=parseInt(o.target.value)/100;this.setVolume(i),this.playSound("click")}),document.getElementById("testSoundButton").addEventListener("click",()=>{console.log("Testing spin sound..."),this.testSound("spin")})}updateVolumeButton(){const e=document.getElementById("muteButton");e&&(e.textContent=this.isMuted?"🔇":"🔊",e.classList.toggle("muted",this.isMuted))}updateVolumeSlider(){const e=document.getElementById("volumeSlider"),t=document.querySelector(".volume-label");e&&(e.value=this.volume*100),t&&(t.textContent=Math.round(this.volume*100)+"%")}onSpinStart(){this.playSound("spin")}onReelStop(){this.playSound("reelStop")}onWin(e=!1){e?this.playSound("jackpot"):this.playSound("win")}onLose(){this.playSound("lose")}onPopupWin(){this.playCustomSound("congratulations")}onPopupLose(){this.playCustomSound("miaw")}playCustomSound(e){if(!(this.isMuted||!this.customSounds||!this.customSounds[e]))try{const t=this.customSounds[e];t.currentTime=0,t.volume=this.volume,t.play().catch(n=>{console.warn(`Could not play ${e} sound:`,n)})}catch(t){console.warn(`Error playing custom sound ${e}:`,t)}}stopCustomSounds(){if(this.customSounds)try{Object.values(this.customSounds).forEach(e=>{e&&!e.paused&&(e.pause(),e.currentTime=0)})}catch(e){console.warn("Error stopping custom sounds:",e)}}onButtonClick(){this.playSound("click")}onBackgroundStart(){this.playSound("background")}testSound(e){console.log(`Testing sound: ${e}`),this.audioContext&&this.audioContext.state==="suspended"?(console.log("Audio context suspended, trying to resume..."),this.audioContext.resume().then(()=>{console.log("Audio context resumed"),this.playSound(e)})):this.playSound(e)}testAllSounds(){["click","spin","reelStop","win","lose","jackpot"].forEach((t,n)=>{setTimeout(()=>{console.log(`Testing ${t}...`),this.testSound(t)},n*1e3)})}}window.soundManager=new E;window.soundManager.loadCustomSounds();class S{constructor(){this.isSpinning=!1,this.reelHeight=null,this.idleTimelines=[]}createReelItems(e,t=null){const n=[];for(let o=0;o<15;o++)e.forEach(i=>{n.push(this.createReelItem(i))});return n}createReelItem(e){const t=document.createElement("div");return t.className="reel-item",t.innerHTML=`
            <img src="${e.image}" alt="${e.name}" onerror="this.src='https://static.vecteezy.com/system/resources/previews/019/040/585/non_2x/an-8-bit-retro-styled-pixel-art-illustration-of-chocolate-free-png.png'">
        `,this.reelHeight||(document.body.appendChild(t),this.reelHeight=t.offsetHeight,document.body.removeChild(t)),t}populateReels(e){document.querySelectorAll(".reel").forEach((n,o)=>{const i=n.querySelector(".reel-strip");i.innerHTML="",this.createReelItems(e).forEach(a=>i.appendChild(a)),gsap.set(i,{y:-this.reelHeight})}),this.startIdleAnimation()}startIdleAnimation(){this.stopIdleAnimation();const e=Array.from(document.querySelectorAll(".reel .reel-strip"));this.idleTimelines=[];const t=[6,7.5,9];e.forEach((n,o)=>{const i=gsap.timeline({repeat:-1}),a=gsap.getProperty(n,"y")-this.reelHeight*10;i.to(n,{y:a,duration:t[o%t.length],ease:"linear"}),this.idleTimelines.push(i)})}stopIdleAnimation(){this.idleTimelines&&this.idleTimelines.length&&this.idleTimelines.forEach(e=>e.kill()),this.idleTimelines=[]}async spinReels(e,t,n){if(this.isSpinning)return;this.isSpinning=!0,this.stopIdleAnimation(),window.soundManager&&window.soundManager.onSpinStart();const o=Array.from(document.querySelectorAll(".reel .reel-strip")),i=document.getElementById("spinButton");if(i.disabled=!0,i.querySelector(".button-text").textContent="SPINNING...",!this.reelHeight){const d=this.createReelItem(t[0]);document.body.appendChild(d),this.reelHeight=d.offsetHeight,document.body.removeChild(d)}const s=30,a=10;o.forEach((d,p)=>{d.innerHTML="";for(let f=0;f<s;f++){const v=t[Math.floor(Math.random()*t.length)];d.appendChild(this.createReelItem(v))}d.appendChild(this.createReelItem(n[p]));for(let f=0;f<a;f++){const v=t[Math.floor(Math.random()*t.length)];d.appendChild(this.createReelItem(v))}const z=Math.floor(d.parentNode.offsetHeight/this.reelHeight),w=this.reelHeight*Math.floor(z/2)-30;gsap.set(d,{y:-(s*this.reelHeight-w)})});const r=o.map((d,p)=>{const z=s,w=Math.floor(d.parentNode.offsetHeight/this.reelHeight),f=this.reelHeight*Math.floor(w/2)-30;return-(z*this.reelHeight-f)}),l=.15,m=15,c=1.5,u=this.reelHeight*10,g=o.map((d,p)=>new Promise(z=>{const w=gsap.timeline({repeat:-1});w.to(d,{y:`-=${u}`,duration:l,ease:"none"}),setTimeout(()=>{w.kill(),gsap.to(d,{y:r[p],duration:1.2,ease:"power3.out",onComplete:()=>{window.soundManager&&window.soundManager.onReelStop(),z()}})},p*c*1e3+m*l*1e3)}));for(let d=0;d<g.length;d++)await g[d];setTimeout(()=>{this.showPrizePopup(e)},100),i.disabled=!1,i.querySelector(".button-text").textContent="SPIN!",this.isSpinning=!1,document.getElementById("closePopup").addEventListener("click",()=>{setTimeout(()=>{this.populateReels(t)},400)},{once:!0})}calculateTargetPositions(e,t){const n=[],o=t.length;for(let i=0;i<3;i++){let s=t.findIndex(c=>c.id===e.id);s===-1&&(s=0);const r=(7+Math.floor(Math.random()*2))*o+s,l=this.reelHeight,m=-(r*this.reelHeight-l);n.push(m)}return n}animateReel(e,t,n){return new Promise(o=>{const i=gsap.timeline();i.to(e,{y:t-this.reelHeight*10,duration:n*.7,ease:"power2.in"}),i.to(e,{y:t,duration:n*.3,ease:"power3.out",onComplete:()=>{o()}})})}showPrizePopup(e){const t=document.getElementById("prizePopup"),n=document.getElementById("wonPrizeImage"),o=document.getElementById("wonPrizeName"),i=document.getElementById("prizePopupTitle"),s=t.querySelector(".prize-shield"),a=new Image;a.onload=()=>{n.src=e.image},a.src=e.image,o.textContent=e.name,gsap.set(t,{force3D:!0}),gsap.set(t.querySelector(".popup-content"),{force3D:!0}),e.isDefault?(i&&(i.textContent="Better luck next time!"),s&&(s.innerHTML=`<img src="./assets/images/Sad_cat.png" alt="Sad Cat" style="width: 120px; height: 120px; object-fit: contain; border-radius: 12px;" onerror="this.src='https://static.vecteezy.com/system/resources/previews/019/040/585/non_2x/an-8-bit-retro-styled-pixel-art-illustration-of-chocolate-free-png.png'">`),setTimeout(()=>{window.soundManager&&window.soundManager.onPopupLose()},100)):(i&&(i.textContent="Congratulations!"),s&&(s.innerHTML=`<img src="./assets/images/cat_win.png" alt="Winner Cat" style="width: 120px; height: 120px; object-fit: contain; border-radius: 12px;" onerror="this.textContent='🏆'">`),setTimeout(()=>{window.soundManager&&window.soundManager.onPopupWin()},100)),t.classList.remove("hidden"),gsap.fromTo(t.querySelector(".popup-content"),{scale:0,rotation:e.isDefault?10:-10,opacity:0},{scale:1,rotation:0,opacity:1,duration:.4,ease:"back.out(1.4)",force3D:!0,onComplete:()=>{e.isDefault&&gsap.to(t.querySelector(".popup-content"),{scale:1.02,duration:.3,ease:"power2.inOut",yoyo:!0,repeat:1,force3D:!0})}}),e.isDefault||setTimeout(()=>{this.triggerConfetti()},200)}triggerConfetti(){const t=Date.now()+3e3,n={startVelocity:30,spread:360,ticks:60,zIndex:1001};function o(s,a){return Math.random()*(a-s)+s}const i=setInterval(function(){const s=t-Date.now();if(s<=0)return clearInterval(i);const a=50*(s/3e3);confetti(Object.assign({},n,{particleCount:a,origin:{x:o(.1,.3),y:Math.random()-.2}})),confetti(Object.assign({},n,{particleCount:a,origin:{x:o(.7,.9),y:Math.random()-.2}}))},250)}closePrizePopup(){const e=document.getElementById("prizePopup");window.soundManager&&window.soundManager.stopCustomSounds(),gsap.set(e.querySelector(".popup-content"),{force3D:!0}),gsap.to(e.querySelector(".popup-content"),{scale:0,rotation:10,opacity:0,duration:.25,ease:"back.in(1.4)",force3D:!0,onComplete:()=>{e.classList.add("hidden"),window.slotMachine&&window.slotMachine.updatePrizeDisplay&&window.slotMachine.updatePrizeDisplay()}})}animatePrizeShowcase(){const e=document.querySelectorAll(".prize-item");gsap.fromTo(e,{y:-50,opacity:0},{y:0,opacity:1,duration:.6,stagger:.1,ease:"back.out(1.7)"})}initializeButtonEffects(){const e=document.getElementById("spinButton");e.addEventListener("mouseenter",()=>{e.disabled||gsap.to(e,{scale:1.05,duration:.2})}),e.addEventListener("mouseleave",()=>{e.disabled||gsap.to(e,{scale:1,duration:.2})})}}window.animationManager=new S;class C{constructor(){this.currentEditingPrize=null,this.initializeEventListeners()}initializeEventListeners(){document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>this.switchTab(e.dataset.tab))}),document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("prizeName");e&&(e.removeAttribute("pattern"),e.style.userSelect="text",e.style.pointerEvents="auto",e.addEventListener("keydown",t=>{t.keyCode===32&&t.stopPropagation()}))}),document.getElementById("closeAdmin").addEventListener("click",()=>{if(storageManager.getPrizes().reduce((n,o)=>n+o.chance,0)!==100){alert("Total win chance must be exactly 100% before closing the admin panel.");return}this.hide()}),document.getElementById("addPrize").addEventListener("click",()=>{window.soundManager&&window.soundManager.onButtonClick(),this.showPrizeEditor()}),document.getElementById("savePrize").addEventListener("click",()=>{window.soundManager&&window.soundManager.onButtonClick(),this.savePrize()}),document.getElementById("cancelEdit").addEventListener("click",()=>{window.soundManager&&window.soundManager.onButtonClick(),this.hidePrizeEditor()}),document.getElementById("resetGame").addEventListener("click",()=>{window.soundManager&&window.soundManager.onButtonClick(),confirm("Are you sure you want to reset the game and clear all logs?")&&this.resetGame()})}show(){document.getElementById("adminPanel").classList.remove("hidden"),this.refreshContent(),setTimeout(()=>{const e=document.getElementById("prizeName");e&&(e.removeAttribute("pattern"),e.style.userSelect="text",e.style.pointerEvents="auto",e.addEventListener("keydown",t=>{t.keyCode===32&&t.stopPropagation()}),console.log("Prize name input initialized for spaces"))},100)}hide(){document.getElementById("adminPanel").classList.add("hidden"),this.hidePrizeEditor(),this.refreshSlotMachine()}switchTab(e){switch(document.querySelectorAll(".tab-button").forEach(t=>{t.classList.remove("active")}),document.querySelector(`[data-tab="${e}"]`).classList.add("active"),document.querySelectorAll(".tab-content").forEach(t=>{t.classList.remove("active")}),document.getElementById(`${e}Tab`).classList.add("active"),e){case"prizes":this.refreshPrizesList();break;case"settings":this.refreshSettings();break;case"logs":this.refreshLogs();break}}refreshContent(){this.refreshPrizesList(),this.refreshSettings(),this.refreshLogs()}refreshPrizesList(){const e=document.getElementById("prizesList"),t=storageManager.getPrizes();e.innerHTML="",t.forEach(n=>{const o=document.createElement("div");o.className="prize-card",o.innerHTML=`
                <img src="${n.image}" alt="${n.name}" onerror="this.src='https://static.vecteezy.com/system/resources/previews/019/040/585/non_2x/an-8-bit-retro-styled-pixel-art-illustration-of-chocolate-free-png.png'">
                <div class="prize-info">
                    <h4>${n.name}</h4>
                    <p>Quantity: ${n.quantity}</p>
                    <p>Win Chance: ${n.chance}%</p>
                </div>
                <div class="prize-actions">
                    <button onclick="adminPanel.editPrize(${n.id})">Edit</button>
                    <button class="delete" onclick="adminPanel.deletePrize(${n.id})">Delete</button>
                </div>
            `,e.appendChild(o)})}showPrizeEditor(e=null){const t=document.getElementById("prizeEditor"),n=document.getElementById("editorTitle");function o(l,m){const c=document.getElementById(l);if(c){let u=document.getElementById(l+"-label");u||(u=document.createElement("label"),u.id=l+"-label",u.htmlFor=l,u.textContent=m,u.style.display="block",u.style.fontWeight="bold",u.style.margin="8px 0 2px 0",c.parentNode.insertBefore(u,c))}}o("prizeName","Prize Name"),o("prizeImage","Prize Image URL"),o("prizeQuantity","Quantity"),o("prizeChance","Win Chance (%)"),this.createImageSourceSelector(),e?(this.currentEditingPrize=e,n.textContent="Edit Prize",document.getElementById("prizeName").value=e.name,document.getElementById("prizeImage").value=e.image||"",document.getElementById("prizeQuantity").value=e.quantity,document.getElementById("prizeChance").value=e.chance,this.updateImageSourceSelector(e.image)):(this.currentEditingPrize=null,n.textContent="Add New Prize",document.getElementById("prizeName").value="",document.getElementById("prizeImage").value="",document.getElementById("prizeQuantity").value="",document.getElementById("prizeChance").value="",this.updateImageSourceSelector(""));let i=document.getElementById("chanceMessage");i||(i=document.createElement("div"),i.id="chanceMessage",i.style.margin="10px 0",i.style.fontWeight="bold",i.style.color="#e74c3c",t.appendChild(i)),this.updateChanceMessage(),document.getElementById("prizeChance").addEventListener("input",()=>{this.updateChanceMessage()});const s=storageManager.getPrizes(),a=s.reduce((l,m)=>m.chance>l.chance?m:l,s[0]||{chance:0});let r=document.getElementById("defaultPrizeLabel");r||(r=document.createElement("div"),r.id="defaultPrizeLabel",r.style.margin="10px 0",r.style.fontWeight="bold",r.style.color="#FFD700",r.style.fontSize="1.1em",t.appendChild(r)),r.textContent=a?`Default Prize: ${a.name} (${a.chance}%)`:"",t.classList.remove("hidden")}updateChanceMessage(){const e=document.getElementById("prizeChance"),t=parseFloat(e.value)||0,n=storageManager.getPrizes();let o=0;this.currentEditingPrize?o=n.reduce((s,a)=>s+(a.id===this.currentEditingPrize.id?t:a.chance),0):o=n.reduce((s,a)=>s+a.chance,0)+t;const i=document.getElementById("chanceMessage");if(o<100)i.textContent=`Total win chance: ${o}%. ${100-o}% left to allocate.`,i.style.color="#e67e22",this.hideAutoAdjustWarning();else if(o>100){const s=o-100;i.textContent=`Total win chance: ${o}%. Exceeded by ${s}%.`,i.style.color="#e74c3c",this.showAutoAdjustWarning(s)}else i.textContent="Total win chance: 100%. Ready to save!",i.style.color="#27ae60",this.hideAutoAdjustWarning()}showAutoAdjustWarning(e){let t=document.getElementById("autoAdjustWarning");if(!t){t=document.createElement("div"),t.id="autoAdjustWarning",t.style.cssText=`
                margin: 15px 0;
                padding: 15px;
                background-color: rgba(255, 193, 7, 0.1);
                border: 2px solid #ffc107;
                border-radius: 8px;
                color: #ff8f00;
                font-weight: bold;
                font-size: 0.95em;
            `,document.getElementById("prizeEditor");const s=document.getElementById("chanceMessage");s.parentNode.insertBefore(t,s.nextSibling)}const n=storageManager.getPrizes();let o=null,i=0;for(const s of n)this.currentEditingPrize&&s.id===this.currentEditingPrize.id||s.chance>i&&(i=s.chance,o=s);if(o){const s=Math.max(.1,i-e);t.innerHTML=`
                <strong>⚠️ Auto-Adjustment Warning</strong><br>
                If you save with this percentage, the excess ${e.toFixed(1)}% will be automatically removed from the highest percentage prize:<br>
                <strong>"${o.name}"</strong> will be reduced from ${i}% to ${s.toFixed(1)}%
            `}else t.innerHTML=`
                <strong>⚠️ Auto-Adjustment Warning</strong><br>
                Total percentage exceeds 100%. The excess will be automatically adjusted when saving.
            `;t.style.display="block"}hideAutoAdjustWarning(){const e=document.getElementById("autoAdjustWarning");e&&(e.style.display="none")}hidePrizeEditor(){document.getElementById("prizeEditor").classList.add("hidden"),this.currentEditingPrize=null}createImageSourceSelector(){if(document.getElementById("imageSourceSelector"))return;const e=document.getElementById("prizeImage"),t=e.parentNode,n=document.createElement("div");n.id="imageSourceSelector",n.className="image-source-selector";const o=document.createElement("label");o.textContent="Image Source",o.style.display="block",o.style.fontWeight="bold",o.style.margin="8px 0 5px 0";const i=document.createElement("div");i.className="image-source-option",i.innerHTML=`
            <label>
                <input type="radio" name="imageSource" value="url" checked>
                <span>Use URL</span>
            </label>
        `;const s=document.createElement("div");s.className="image-source-option",s.innerHTML=`
            <label>
                <input type="radio" name="imageSource" value="asset">
                <span>Choose from Assets</span>
            </label>
        `;const a=document.createElement("div");a.id="assetGallery",a.className="asset-gallery hidden",y.forEach(m=>{const c=document.createElement("div");c.className="asset-item",c.dataset.assetId=m.id,c.dataset.assetPath=m.path;const u=P(m.filename);c.innerHTML=`
                <img src="${u}" alt="${m.name}" title="${m.description}">
                <span>${m.name}</span>
            `,c.addEventListener("click",()=>{this.selectAsset(m)}),a.appendChild(c)});const r=document.createElement("div");r.id="imagePreview",r.className="image-preview",r.innerHTML=`
            <label>Preview:</label>
            <div class="preview-content">
                <img id="previewImage" src="" alt="No image selected" style="display: none;">
                <span id="previewText">No image selected</span>
            </div>
        `,[i,s].forEach(m=>{const c=m.querySelector('input[type="radio"]');c.addEventListener("change",()=>{this.handleImageSourceChange(c.value)})}),e.addEventListener("input",()=>{this.updateImagePreview(e.value)}),t.insertBefore(o,e),t.insertBefore(n,e),n.appendChild(i),n.appendChild(s),n.appendChild(a),t.insertBefore(r,e.nextSibling)}updateImageSourceSelector(e){const t=document.querySelector('input[name="imageSource"][value="url"]'),n=document.querySelector('input[name="imageSource"][value="asset"]');if(y.some(i=>{const s=P(i.filename);return e===s||e===i.path||e.includes(i.filename)})){n.checked=!0,this.handleImageSourceChange("asset");const i=y.find(s=>{const a=P(s.filename);return e===a||e===s.path||e.includes(s.filename)});i&&this.highlightSelectedAsset(i.id)}else t.checked=!0,this.handleImageSourceChange("url");this.updateImagePreview(e)}handleImageSourceChange(e){const t=document.getElementById("prizeImage"),n=document.getElementById("assetGallery");e==="asset"?(t.style.display="none",n.classList.remove("hidden")):(t.style.display="block",n.classList.add("hidden"),this.clearAssetSelection())}selectAsset(e){const t=document.getElementById("prizeImage"),n=P(e.filename);t.value=n,this.highlightSelectedAsset(e.id),this.updateImagePreview(n)}highlightSelectedAsset(e){document.querySelectorAll(".asset-item").forEach(n=>{n.classList.remove("selected")});const t=document.querySelector(`[data-asset-id="${e}"]`);t&&t.classList.add("selected")}clearAssetSelection(){document.querySelectorAll(".asset-item").forEach(e=>{e.classList.remove("selected")})}updateImagePreview(e){const t=document.getElementById("previewImage"),n=document.getElementById("previewText");e&&e.trim()?(t.src=e,t.style.display="block",n.style.display="none",t.onerror=()=>{t.style.display="none",n.style.display="block",n.textContent="Failed to load image"}):(t.style.display="none",n.style.display="block",n.textContent="No image selected")}savePrize(){const e=document.getElementById("prizeName").value.trim(),t=document.getElementById("prizeImage").value.trim(),n=parseInt(document.getElementById("prizeQuantity").value),o=parseFloat(document.getElementById("prizeChance").value);let i=document.getElementById("chanceMessage");if(!e||!t||n<0||o<0||o>100){i.textContent="Please fill all fields with valid values.",i.style.color="#e74c3c";return}const s=storageManager.getPrizes();let a=0;if(this.currentEditingPrize?a=s.reduce((c,u)=>c+(u.id===this.currentEditingPrize.id?o:u.chance),0):a=s.reduce((c,u)=>c+u.chance,0)+o,a>100){const c=a-100;let u=null,g=0;for(const d of s)this.currentEditingPrize&&d.id===this.currentEditingPrize.id||d.chance>g&&(g=d.chance,u=d);if(u){const d=Math.max(.1,g-c),p={...u,chance:d};storageManager.updatePrize(p),i.textContent=`Auto-adjusted: "${u.name}" reduced from ${g}% to ${d.toFixed(1)}% to maintain 100% total.`,i.style.color="#ff8f00"}}const r=Math.min(a,100);r<100?(i.textContent=`Saved. ${100-r}% left to allocate. You must reach 100% before finishing.`,i.style.color="#e67e22"):(a>100?i.textContent="Saved with auto-adjustment! Total win chance is now 100%.":i.textContent="Saved! Total win chance is 100%. Ready to go.",i.style.color="#27ae60");const l={name:e,image:t,quantity:n,chance:o};this.currentEditingPrize?(l.id=this.currentEditingPrize.id,storageManager.updatePrize(l)):storageManager.addPrize(l),this.hideAutoAdjustWarning();const m=storageManager.getPrizes().reduce((c,u)=>c+u.chance,0);Math.abs(m-100)<.01&&this.hidePrizeEditor(),this.refreshPrizesList(),window.slotMachine&&(window.slotMachine.updatePrizeDisplay(),window.slotMachine.populateReels())}editPrize(e){const n=storageManager.getPrizes().find(o=>o.id===e);n&&this.showPrizeEditor(n)}deletePrize(e){confirm("Are you sure you want to delete this prize?")&&(storageManager.deletePrize(e),this.refreshPrizesList(),window.slotMachine&&(window.slotMachine.updatePrizeDisplay(),window.slotMachine.populateReels()))}refreshSettings(){}resetGame(){storageManager.resetAll(),this.refreshContent(),window.slotMachine&&window.slotMachine.initialize(),alert("Game has been reset successfully!")}refreshLogs(){const e=document.getElementById("spinLogs"),t=storageManager.getLogs();if(e.innerHTML="",t.length===0){e.innerHTML="<p>No spins recorded yet.</p>";return}t.forEach(n=>{const o=document.createElement("div");o.className="log-entry";const i=new Date(n.timestamp).toLocaleString();o.innerHTML=`
                <strong>${i}</strong><br>
                Prize: ${n.prizeName}<br>
                Mode: ${n.gameMode}
                ${n.gameMode==="duration"?`<br>Remaining in deck: ${n.remainingInDeck}`:""}
            `,e.appendChild(o)})}refreshSlotMachine(){window.slotMachine&&window.slotMachine.populateReels()}}function M(){const h=prompt("Enter admin password:");h==="admin123"?adminPanel.show():h!==null&&alert("Invalid password")}window.showAdminLogin=M;window.adminPanel=new C;class x{constructor(){this.cachedPrizes=null,this.cachedAvailablePrizes=null,this.cachedTotalChance=null,this.lastPrizeUpdate=0,this.initialize(),this.setupEventListeners()}initialize(){this.updatePrizeDisplay(),this.populateReels(),this.initializeAnimations(),setTimeout(()=>{window.soundManager&&window.soundManager.onBackgroundStart()},2e3)}setupEventListeners(){let e=!1;document.getElementById("spinButton").addEventListener("click",()=>{e||animationManager.isSpinning||(e=!0,setTimeout(()=>e=!1,300),window.soundManager&&window.soundManager.onButtonClick(),this.spin())}),document.getElementById("closePopup").addEventListener("click",()=>{window.soundManager&&window.soundManager.onButtonClick(),animationManager.closePrizePopup()});let t=!1;document.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&!t&&!animationManager.isSpinning&&(n.preventDefault(),t=!0,setTimeout(()=>t=!1,300),this.spin())})}updatePrizeDisplay(){const e=document.getElementById("prizeList"),t=storageManager.getPrizes(),n=Date.now();if(this.cachedPrizes&&JSON.stringify(this.cachedPrizes)===JSON.stringify(t)&&n-this.lastPrizeUpdate<100)return;this.cachedPrizes=[...t],this.lastPrizeUpdate=n,this.clearPrizeCache();const o=document.createDocumentFragment();t.forEach(i=>{const s=document.createElement("div");s.className="prize-item",i.quantity===0&&s.classList.add("out-of-stock"),s.innerHTML=`
                <img src="${i.image}" alt="${i.name}" onerror="this.src='https://static.vecteezy.com/system/resources/previews/019/040/585/non_2x/an-8-bit-retro-styled-pixel-art-illustration-of-chocolate-free-png.png'">
                <span>${i.name}</span>
                ${i.quantity===0?'<div class="out-of-stock-overlay"><div class="x-mark">X</div></div>':""}
            `,o.appendChild(s)}),e.innerHTML="",e.appendChild(o),setTimeout(()=>{animationManager.animatePrizeShowcase()},100)}clearPrizeCache(){this.cachedAvailablePrizes=null,this.cachedTotalChance=null}getAvailablePrizes(e){return this.cachedAvailablePrizes||(this.cachedAvailablePrizes=e.filter(t=>t.quantity>0),this.cachedTotalChance=this.cachedAvailablePrizes.reduce((t,n)=>t+n.chance,0)),{prizes:this.cachedAvailablePrizes,totalChance:this.cachedTotalChance}}populateReels(){const e=storageManager.getPrizes();animationManager.populateReels(e)}initializeAnimations(){animationManager.initializeButtonEffects()}spin(){if(animationManager.isSpinning)return;const e=storageManager.getPrizes();if(e.length===0){alert("No prizes available! Please add some prizes in the admin panel.");return}const t=this.determineWinningPrize(e);if(!t){alert("No more prizes available!");return}let n=[],o=t;const i=e.reduce((s,a)=>a.chance>s.chance?a:s,e[0]||{chance:0});if(t.id===i.id){const s=e.filter(a=>a.id!==i.id);if(s.length===0)n=[i,i,i];else{const a=Math.floor(Math.random()*s.length);let r=Math.floor(Math.random()*s.length),l=Math.floor(Math.random()*s.length);if(Math.random()<.5)r=a;else for(;r===a&&s.length>1;)r=Math.floor(Math.random()*s.length);for(;(l===a||l===r)&&s.length>1;)l=Math.floor(Math.random()*s.length);n=[s[a],s[r],s[l]]}n[0].id===n[1].id&&n[1].id===n[2].id?o=n[0]:o=i}else n=[t,t,t],o=t;o={...o,isDefault:o.id===i.id},this.logSpin(o),this.clearPrizeCache(),animationManager.spinReels(o,e,n)}determineWinningPrize(e){return this.selectPrizeByProbability(e)}selectPrizeByProbability(e){const{prizes:t,totalChance:n}=this.getAvailablePrizes(e);if(t.length===0)return console.log("❌ No prizes available - all quantities exhausted!"),null;if(n===0)return t[Math.floor(Math.random()*t.length)];let o=Math.random()*n;console.log("🎲 Spin - Available prizes:",t.length,"Total chance:",n),console.log("   Random value:",o.toFixed(3));let i=null,s=0;for(const a of t)if(s+=a.chance,console.log(`  ${a.name}: ${(s-a.chance).toFixed(1)} - ${s.toFixed(1)} (${a.chance}% of ${n}) [Qty: ${a.quantity}]`),o<=s&&!i){i=a,console.log(`✅ Selected: ${a.name}`);const r={...a,quantity:a.quantity-1};storageManager.updatePrize(r),console.log(`📦 ${a.name} quantity: ${a.quantity} → ${r.quantity}`),r.quantity===0&&console.log(`🚫 ${a.name} is now exhausted and will be removed from future spins!`);break}return i||(i=t[t.length-1],console.log("⚠️ Fallback selected:",i.name)),i}testProbabilityAccuracy(e=100){console.log(`
🧪 Testing quantity-based probability system with ${e} iterations...`);const t=storageManager.getPrizes(),n={},o={};t.forEach(s=>{n[s.name]=0,o[s.name]=s.quantity}),console.log(`
📦 Starting quantities:`),t.forEach(s=>{console.log(`  ${s.name}: ${s.quantity} (${s.chance}%)`)});for(let s=0;s<e;s++){const a=storageManager.getPrizes();if(a.filter(m=>m.quantity>0).length===0){console.log(`
🏁 All prizes exhausted after ${s} spins!`);break}const l=this.selectPrizeByProbability(a);l&&n[l.name]++}console.log(`
📊 Final Results:`),console.log("Prize		Wins	Original Qty	Remaining"),console.log("─".repeat(50));const i=storageManager.getPrizes();Object.keys(n).forEach(s=>{const a=i.find(c=>c.name===s),r=n[s],l=o[s],m=a?a.quantity:0;console.log(`${s.padEnd(15)}	${r}	${l}		${m}`)}),console.log(`
✅ Test completed. Quantities should decrease as prizes are won.`),console.log("💡 Reset the game to restore original quantities.")}logSpin(e){const t={prizeName:e.name,gameMode:"Probability"};storageManager.addLog(t)}}document.addEventListener("DOMContentLoaded",()=>{window.slotMachine=new x,window.testProbability=(h=1e3)=>{window.slotMachine.testProbabilityAccuracy(h)},console.log("🎰 Slot Machine loaded! Test probability with: testProbability(1000)")});
